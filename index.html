<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Document</title>
    
    <script
    src="http://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

    
    
    <script type="text/javascript">
        
        function inRange(x, min, max) {
            return ((x-min)*(x-max) <= 0);
        }

        function fretNumber(xPos){
            // Find fret number
            var i = 0;
            var fret = 1;
            while (! inRange(xPos,i,i+45)){
                i += 45;
                fret = (i/45)+1; 

                // catch infinite loop
                if (i>=700){
                    break;
                }
            }
            
            return fret;   
        }

        function stringNumber(yPos){
            var strings = [[0,10],[25,42],[55,72],[86,104],[118,135],[149,159]];
                var string;
                for (var j = 0;j < strings.length; j++){
                    
                    if (inRange(yPos,strings[j][0],strings[j][1])){
                        
                        string = j;
                        
                        break;
                    }
                }
                // Fix string names so they dont start at 0 
                string += 1;
            return string;
        }
        
        function say_stuff(){
            var data = jQuery.getJSON("/notes/guitar.json");
            console.log(data);
        }
        
        $(document).ready(function(){
            one.classList.toggle('show');

            say_stuff();

            $("#fretmap").mouseover(function(e){
                
                //e.preventDefault();
                $('.dot').hide();

                // Find position of click 
                var elm = $('.fretboard');
                var pad = $(".background").css('padding');
                var xPos = e.pageX - elm.offset().left;
                var yPos = e.pageY - elm.offset().top;

                // Current left padding
                var left = $('.dot').css('left');
                var top = $('.dot').css('top');

                
                var pos = 25;

                fret = fretNumber(xPos);
                
                string = stringNumber(yPos);

                
                // Shift ball 'pos' to the right depending on fret
                pos = (fret*45) -20;
                // Hardcoded outliers

                if (fret>6){
                    pos = (fret*45)-25;
                }

                // shift ball down by 'top' amount depending on string
                var top;
                top = ((string-1)*30) + 5;

                // Hardcoded outliers
                if (string == 5){
                    top = 128;
                }
                if (string == 6){
                    top = 158;
                }
                
                // 
                $('area').hover(function(){
                    $(this).css({'left':pos});
                    $(this).css({'top':top});  
                    
                });

            });

            
            // Find the note clicked
            $('#fretmap').click(function(e){
                e.preventDefault();
                // Find position of click 
                var elm = $('.fretboard');
                var fret;
                var pad = $(".background").css('padding');
                var xPos = e.pageX - elm.offset().left;
                var yPos = e.pageY - elm.offset().top;
                
                
                fret = fretNumber(xPos);   
                string = stringNumber(yPos);

                moveNote(string,fret);
                
                //console.log('click found');

            });

           
        });
            var notes = ['C','C#','D','D#','E','F','F#','G','G#','A','Bb','B']
            var openstrings = ['E','B','G','D','A','E'];
            var fretPos = [18,63,107,150,195,240,283,330,372,418,462,507,551,595,640];
            var notesPlayed = [['E',4],['B',3],['G',3],['D',3],['A',2],['E',2]];
            var chordNotation;

            // Return the note name value
            function note(open,fret){
                //console.log(open+fret)
                if (open + fret >= 12){   
                    if (open+fret>=24){
                        return notes[open+fret-24]
                    }
                    return notes[open + fret - 12];
                }
                else{
                    return notes[open+fret];
                }
            }
            // Update the note octaves
            function update(string,fret){
                let orig_octaves = [4,3,3,3,2,2];
                let octave;
                if (string==1){
                    if (inRange(fret,1,7)) octave = 4;
                    else octave = 5;
                }
                if (string==2){
                    if (inRange(fret,1,12)) octave = 4;
                    else octave = 5;
                }
                if (string==3){
                    if (inRange(fret,1,4)) octave = 3;
                    else octave = 4;
                }
                if (string==4){
                    if (inRange(fret,1,9)) octave = 3;
                    else octave = 4;
                }
                if (string==5){
                    if (inRange(fret,1,2)) octave = 2;
                    else if (inRange(fret,3,14)) octave = 3;
                    else octave = 4;
                }
                if (string==6){
                    if (inRange(fret,1,7)) octave = 2;
                    else octave = 3;
                }
                if (fret==0){
                    console.log('octave='+octave)
                    octave = orig_octaves[string-1];
                }
                notesPlayed[string-1][1] = octave;
                console.log('NOTE=' + notesPlayed[string-1][0]+notesPlayed[string-1][1]);
            }
            // main function to move the notes and update their octave
            function moveNote(stringnum,fret){
                var stringName = '.string' + stringnum;
                var openString = '.open' + stringnum;
                pos = fretPos[fret-1]
                xName = '.x' + stringnum;

                if (fret==-1){
                    $(stringName).hide();
                    
                    console.log('show it');
                    $(xName).show();
                    //$('.mute1').toggle('activ');
                    console.log('string clicked:'+stringnum);
                    notesPlayed[stringnum-1][0] = ""; // note is muted

                    console.log(notesPlayed);
                }
                else{
                    
                    $(stringName).show();
                    $(xName).hide();
                    // If an notes are clicked
                    if (fret==0){
                        noteName = openstrings[stringnum-1];
                        $(stringName).css({"left":-20});
                        $(stringName).text(noteName)
                    }
                    // If any other note is clicked 
                    else{
                        open = notes.indexOf(openstrings[stringnum-1])
                        noteName = note(open,fret);
                        
                        $(stringName).text(noteName);
                        $(stringName).css({"left":pos});
                    }

                    notesPlayed[stringnum-1][0] = noteName; // Update the note names
                    update(stringnum,fret); // Update note octave

                    var finalNote = notesPlayed[stringnum-1][0];

                    // Switch # to s for audio finding
                    if (finalNote[1]=="#"){
                        finalNote = finalNote[0] + 's' 
                    }
                    // Switch Bb to As
                    if (finalNote=="Bb"){
                        finalNote = "As";
                    }

                    // Play the audio 
                    let noteToPlay = finalNote + notesPlayed[stringnum-1][1]
                    $("#myAudio").attr("src","/notes/"+ noteToPlay+'.mp3');
                    var x = document.getElementById("myAudio"); 
                    x.play()
                    console.log(notesPlayed);
                }

            }
        
        

    </script>
</head>
<body>
    <audio id="myAudio">
        <source src="" type="audio/mp3">
    </audio>

    
    <div id="buttons">
        <button class="open1" onclick="moveNote('1','0')"></button>
        <button class="open2" onclick="moveNote('2','0')"></button>
        <button class="open3" onclick="moveNote('3','0')"></button>
        <button class="open4" onclick="moveNote('4','0')"></button>
        <button class="open5" onclick="moveNote('5','0')"></button>
        <button class="open6" onclick="moveNote('6','0')"></button>
    </div>
    
    <div class="background">
        <div id="mutes">
            <button class="mute mute1" onclick="moveNote('1','-1')">X</button>
            <button class="mute mute2" onclick="moveNote('2','-1')">X</button>
            <button class="mute mute3" onclick="moveNote('3','-1')">X</button>
            <button class="mute mute4" onclick="moveNote('4','-1')">X</button>
            <button class="mute mute5" onclick="moveNote('5','-1')">X</button>
            <button class="mute mute6" onclick="moveNote('6','-1')">X</button>

        </div>

        <span class="popuptext x1" id="myPopup">X</span>
        <span class="popuptext x2" id="myPopup">X</span>
        <span class="popuptext x3" id="myPopup">X</span>
        <span class="popuptext x4" id="myPopup">X</span>
        <span class="popuptext x5" id="myPopup">X</span>
        <span class="popuptext x6" id="myPopup">X</span>




        <img class="fretboard" src="fretboard.png" alt="fretboard" usemap="#fretmap">
        
        
        <map name="fretmap" id ="fretmap">
  
            <area
            shape="rect"
            coords="15,0,670,10"
            >
            <area
            shape="rect"
            coords="15,25,670,42"
            >
            <area
            shape="rect"
            coords="15,0,670,10"
            >
            <area
            shape="rect"
            coords="15,55,670,72"
            >
            <area
            shape="rect"
            coords="15,86,670,104"
            >
            <area
            shape="rect"
            coords="15,118,670,135"
            >
            <area
            shape="rect"
            coords="15,149,670,159"
            >
            

        </map>
        

        <span class="dot"></span>

        <div id="one">
            <div class="string1">E</div>
            <div class="string2">B</div>
            <div class="string3">G</div>
            <div class="string4">D</div>
            <div class="string5">A</div>
            <div class="string6">E</div>
        </div>
        
    </div>
    
</body>
</html>
